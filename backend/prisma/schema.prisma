generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ADVOGADOS MONITORADOS
// ============================================================================

model Advogado {
  id                String   @id @default(uuid())

  // Dados para busca
  nome              String
  oab               String?
  ufOab             String?

  // Vinculo com AdvWell
  advwellCompanyId  String   // ID da empresa no AdvWell
  advwellClientId   String?  // ID do cliente no AdvWell (para vincular processos)

  // Configuracoes
  ativo             Boolean  @default(true)
  tribunais         String[] // TJRJ, TJSP, etc. Vazio = todos

  // Callback
  callbackUrl       String?  // URL para notificar AdvWell

  // Stats
  ultimaConsulta    DateTime?
  totalPublicacoes  Int      @default(0)

  // Buffer/Cache - Sincronizacao automatica
  ultimaSincronizacao DateTime?  // Quando foi feita a ultima busca automatica
  totalAndamentos     Int      @default(0)  // Total de andamentos no banco
  sincronizacaoAtiva  Boolean  @default(true)  // Se deve sincronizar automaticamente

  // Metadados
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relacoes
  publicacoes       Publicacao[]
  consultas         Consulta[]

  @@index([advwellCompanyId])
  @@index([ativo])
  @@index([nome])
  @@index([sincronizacaoAtiva])
}

// ============================================================================
// PUBLICACOES ENCONTRADAS
// ============================================================================

model Publicacao {
  id                  String    @id @default(uuid())

  // Vinculo
  advogadoId          String
  advogado            Advogado  @relation(fields: [advogadoId], references: [id], onDelete: Cascade)

  // Dados da publicacao
  numeroProcesso      String
  siglaTribunal       String?
  orgaoJulgador       String?
  dataDisponibilizacao DateTime?
  dataPublicacao      DateTime?
  tipoComunicacao     String?
  textoComunicacao    String?   @db.Text
  textoLimpo          String?   @db.Text  // Texto sem HTML/tags
  linkIntegra         String?

  // Dados extraidos do texto da publicacao
  parteAutor          String?   @db.Text  // AUTOR: Nome(s)
  parteReu            String?   @db.Text  // REU: Nome(s)
  comarca             String?             // Comarca da Capital, Regional de Bangu, etc
  classeProcessual    String?             // PROCEDIMENTO COMUM CIVEL, EXECUCAO FISCAL, etc
  advogadosProcesso   Json?               // Lista de advogados do processo [{nome, oab}]
  nomeOrgao           String?             // Nome do órgão julgador

  // Hash para evitar duplicatas
  hashConteudo        String?

  // Status
  status              PublicacaoStatus @default(NOVA)
  enviadoAdvwell      Boolean   @default(false)
  enviadoEm           DateTime?

  // Metadados
  fonte               String    @default("HCOMUNICA_CNJ")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([advogadoId, numeroProcesso, dataPublicacao, hashConteudo])
  @@index([advogadoId])
  @@index([status])
  @@index([dataPublicacao])
  @@index([enviadoAdvwell])
}

enum PublicacaoStatus {
  NOVA
  PROCESSANDO
  ENVIADA
  ERRO
  IGNORADA
}

// ============================================================================
// FILA DE CONSULTAS
// ============================================================================

model Consulta {
  id              String         @id @default(uuid())

  // Vinculo
  advogadoId      String
  advogado        Advogado       @relation(fields: [advogadoId], references: [id], onDelete: Cascade)

  // Parametros da consulta
  dataInicio      DateTime
  dataFim         DateTime
  tribunal        String?

  // Status da fila
  status          ConsultaStatus @default(PENDENTE)
  prioridade      Int            @default(0)
  tentativas      Int            @default(0)
  maxTentativas   Int            @default(3)

  // Resultado
  publicacoesEncontradas Int?
  publicacoesNovas       Int?      // Quantas eram realmente novas (nao duplicadas)
  erro            String?

  // Proxy usado
  proxyId         String?
  proxy           Proxy?         @relation(fields: [proxyId], references: [id])

  // Detalhes da raspagem
  duracaoMs       Int?            // Duracao total em milissegundos
  paginasNavegadas Int?           // Quantas paginas foram navegadas
  blocosProcessados Int?          // Quantos blocos de 1 ano foram processados
  captchaDetectado Boolean        @default(false)
  bloqueioDetectado Boolean       @default(false)
  detalhesRaspagem Json?          // Detalhes extras da raspagem

  // Timestamps
  agendadoPara    DateTime       @default(now())
  iniciadoEm      DateTime?
  finalizadoEm    DateTime?
  createdAt       DateTime       @default(now())

  @@index([status])
  @@index([agendadoPara])
  @@index([advogadoId])
}

enum ConsultaStatus {
  PENDENTE
  PROCESSANDO
  CONCLUIDA
  ERRO
  CANCELADA
}

// ============================================================================
// PROXIES
// ============================================================================

model Proxy {
  id              String       @id @default(uuid())

  // Dados do proxy
  host            String
  porta           Int
  usuario         String?
  senha           String?
  protocolo       String       @default("http") // http, https, socks5

  // Status
  ativo           Boolean      @default(true)
  funcionando     Boolean      @default(true)

  // Metricas
  totalConsultas  Int          @default(0)
  consultasSucesso Int         @default(0)
  consultasFalha  Int          @default(0)
  ultimoUso       DateTime?
  ultimoErro      String?

  // Rate limiting
  consultasPorHora Int         @default(60)
  consultasHoraAtual Int       @default(0)
  horaAtualInicio DateTime?

  // Health check
  ultimoHealthCheck     DateTime?
  falhasConsecutivas    Int       @default(0)
  bloqueadoCnj          Boolean   @default(false)
  dataBloqueioCnj       DateTime?
  necessitaSubstituicao Boolean   @default(false)

  // Metadados
  nome            String?      // Nome amigavel
  provedor        String?      // Webshare, BrightData, etc
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relacoes
  consultas       Consulta[]

  @@unique([host, porta])
  @@index([ativo, funcionando])
}

// ============================================================================
// LOGS E METRICAS
// ============================================================================

model ExecucaoLog {
  id              String   @id @default(uuid())

  tipo            String   // VARREDURA, CONSULTA, ENVIO, ERRO
  descricao       String
  detalhes        Json?

  // Metricas
  advogadosProcessados Int?
  publicacoesEncontradas Int?
  publicacoesNovas Int?
  erros           Int?
  duracaoMs       Int?

  createdAt       DateTime @default(now())

  @@index([tipo])
  @@index([createdAt])
}

// ============================================================================
// ALERTAS E ERROS DO SISTEMA
// ============================================================================

model LogSistema {
  id              String   @id @default(uuid())

  tipo            LogTipo  @default(ERRO)
  categoria       String   // PROXY, SCRAPER, CALLBACK, SISTEMA
  titulo          String
  mensagem        String   @db.Text

  // Contexto
  proxyId         String?
  advogadoId      String?
  consultaId      String?

  // Status
  lido            Boolean  @default(false)
  resolvido       Boolean  @default(false)
  resolvidoEm     DateTime?

  createdAt       DateTime @default(now())

  @@index([tipo])
  @@index([categoria])
  @@index([lido])
  @@index([createdAt])
}

enum LogTipo {
  INFO
  ALERTA
  ERRO
  CRITICO
}

// ============================================================================
// CONFIGURACOES
// ============================================================================

model Configuracao {
  id              String   @id @default(uuid())
  chave           String   @unique
  valor           String
  descricao       String?
  updatedAt       DateTime @updatedAt
}

// ============================================================================
// USUARIOS DO DASHBOARD
// ============================================================================

model Usuario {
  id              String   @id @default(uuid())
  email           String   @unique
  senha           String
  nome            String
  ativo           Boolean  @default(true)
  role            String   @default("user") // admin, user
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relacoes
  apiKeys         ApiKey[]
}

// ============================================================================
// API KEYS PARA INTEGRACAO
// ============================================================================

model ApiKey {
  id              String   @id @default(uuid())

  // Dados da key
  nome            String              // Nome descritivo da key
  key             String   @unique    // SHA256 hash da key (64 chars hex)
  prefixo         String              // Primeiros 8 chars para identificacao

  // Vinculo com usuario que criou
  usuarioId       String
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Status
  ativa           Boolean  @default(true)

  // Metricas de uso
  totalRequisicoes Int     @default(0)
  ultimoUso       DateTime?

  // Metadados
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([key])
  @@index([ativa])
  @@index([usuarioId])
}

// ============================================================================
// LOG DE REQUISICOES API
// ============================================================================

model ApiRequestLog {
  id              String   @id @default(uuid())

  // Identificacao da requisicao
  metodo          String              // GET, POST, PUT, DELETE
  path            String              // /api/consulta, /api/advogados, etc
  queryParams     Json?               // Query string parameters

  // Origem
  ip              String?             // IP do cliente
  userAgent       String?             // User-Agent header
  apiKeyId        String?             // ID da API Key usada (se autenticado)
  apiKeyPrefixo   String?             // Prefixo da API Key para identificacao rapida
  origem          String?             // Origem da requisicao (AdvWell, Dashboard, etc)

  // Conteudo da requisicao
  requestBody     Json?               // Body da requisicao (sem dados sensiveis)
  requestHeaders  Json?               // Headers relevantes

  // Resposta
  statusCode      Int                 // HTTP status code
  responseBody    Json?               // Body da resposta (resumido)
  responseTime    Int?                // Tempo de resposta em ms

  // Status
  sucesso         Boolean             @default(true)
  erro            String?             // Mensagem de erro se houver

  // Contexto
  advogadoId      String?             // Se a requisicao era sobre um advogado
  consultaId      String?             // Se criou uma consulta
  companyId       String?             // CompanyId do AdvWell

  createdAt       DateTime            @default(now())

  @@index([metodo])
  @@index([path])
  @@index([apiKeyId])
  @@index([sucesso])
  @@index([createdAt])
  @@index([companyId])
}
